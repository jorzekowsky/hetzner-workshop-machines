- hosts: all
  tasks:
  - name: Upgrade APT-Systems
    apt: 
      update_cache: yes
      upgrade: safe

  - name: Add certbot apt repository
    apt_repository:
      repo: 'ppa:nginx/stable'
      state: present  
  - name: Add Dockerâ€™s official GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present
  - name: Add docker apt repository
    apt_repository:
      repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
      state: present

  - name: Install packages
    package: name={{ item }} state=latest
    with_items:
      - apt-transport-https
      - ca-certificates
      - curl
      - software-properties-common
      - gpg-agent
      - git
      - python3-pip
      - nginx
      - docker-ce
      - python3-certbot-nginx

  - name: Install Compose on Linux systems
    get_url:
      url: "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-{{ ansible_system }}-{{ ansible_architecture }}"
      dest: /usr/local/bin/docker-compose
      mode: 0755
      force: yes

  - name: copy nginx server conf
    template:
      src: templates/nginx.conf.j2
      dest: /etc/nginx/sites-available/server.conf

  - name: enable nginx server conf
    ansible.builtin.file:
      src:  /etc/nginx/sites-available/server.conf
      dest: /etc/nginx/sites-enabled/server.conf
      state: link
    notify: restart nginx

  - name: disable nginx default conf
    ansible.builtin.file:
      dest: /etc/nginx/sites-enabled/default
      state: absent
    notify: restart nginx

  - name: Git clone
    git:
      repo: 'https://github.com/dnlkoch/geoserver-docker-compose'
      dest: /root/docker-compose

  - name: Install python packages
    pip:
      name: ["docker", "docker-compose"]
      executable: pip3

  - name: Tear down existing services
    community.general.docker_compose:
      project_src: docker-compose
      state: absent

  - name: Create and start services
    community.general.docker_compose:
      project_src: docker-compose
    register: output

  - ansible.builtin.debug:
      var: output

  - name: enable lets encrypt
    ansible.builtin.shell:
      cmd: certbot -n -m admin@terrestris.de --nginx -d {{ ansible_eth0.ipv4.address }}.nip.io --agree-tos --redirect --hsts --test-cert

  handlers:
  - name: restart nginx
    ansible.builtin.service:
      name: nginx
      state: restarted
